<!DOCTYPE html>
<html lang="en" x-bind:class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" id="theme-color" />
    <title>Kite</title>
    <link rel="manifest" href="{{ static_path }}/manifest.json" />
    <link rel="icon" type="image/svg+xml" href="{{ static_path }}/svg/kite.svg" />
    <link rel="apple-touch-icon" href="{{ static_path }}/apple-touch-icon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="{{ static_path }}/kite.css?{{ timestamp }}" />
    <script>
        const timestamp = Date.now();
        let mediaData = null;

        // Load media data immediately
        fetch('{{ static_path }}/media_data.json')
            .then((response) => response.json())
            .then((data) => {
                // Transform array into lookup object
                const lookup = {};
                data.forEach((item) => {
                    if (item.domains) {
                        item.domains.forEach((domain) => {
                            lookup[domain.toLowerCase()] = item;
                        });
                    }
                });

                mediaData = {
                    raw: data,
                    lookup: lookup,
                };
            })
            .catch((error) => {
                // Error handling for media data loading
            });
    </script>
    <link
        rel="alternate"
        :href="currentCategory === 'OnThisDay' ? 'https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday' : currentCategory.toLowerCase() + '.xml'"
        type="application/rss+xml"
        :title="'Kagi News - ' + currentCategory"
    />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a202c',
                            text: '#e2e8f0',
                        },
                    },
                },
                fontSize: {
                    xs: '0.75rem', // 12px
                    sm: '0.875rem', // 14px
                    base: '1rem', // 16px
                    lg: '1.125rem', // 18px
                    xl: '1.35rem',
                    '2xl': '1.5rem',
                    '3xl': '1.8rem',
                    '4xl': '2rem',
                },
            },
        };
        document.addEventListener('alpine:init', () => {
            Alpine.data('sourceOverlay', () => ({
                showSourceOverlay: false,
                currentSource: { name: '', favicon: '' },
                sourceArticles: [],
                currentStory: null,
                mediaInfo: null,
                showSourceInfo: false,

                async processSource($event) {
                    if (!mediaData?.lookup) {
                        console.log('Media data not yet loaded, fetching...');
                        const response = await fetch('{{ static_path }}/media_data.json');
                        const data = await response.json();
                        const lookup = {};
                        data.forEach((item) => {
                            if (item.domains) {
                                item.domains.forEach((domain) => {
                                    lookup[domain.toLowerCase()] = item;
                                });
                            }
                        });
                        mediaData = {
                            raw: data,
                            lookup: lookup,
                        };
                    }

                    this.showSourceOverlay = true;
                    this.currentSource = $event.detail.domain || {
                        name: '',
                        favicon: '',
                    };
                    this.currentStory = $event.detail.story || null;
                    this.sourceArticles =
                        this.currentStory && this.currentSource?.name
                            ? this.currentStory.articles.filter((a) => a.domain === this.currentSource.name)
                            : [];

                    this.mediaInfo = null;
                    if (this.currentSource?.name) {
                        const lookupKey = this.currentSource.name.toLowerCase();
                        this.mediaInfo = mediaData?.lookup?.[lookupKey];
                    }

                    this.showSourceInfo = false;
                },
            }));
            // Ensure media data is loaded
            if (!mediaData) {
                fetch('{{ static_path }}/media_data.json')
                    .then((response) => response.json())
                    .then((data) => {
                        mediaData = data;
                    })
                    .catch((error) => {
                        console.error('Error loading media data:', error);
                    });
            }

            Alpine.store('intro', {
                shown: localStorage.getItem('introShown') === 'true',
                set(value) {
                    this.shown = value;
                    localStorage.setItem('introShown', value);
                },
            });

            Alpine.store('theme', {
                current: localStorage.getItem('theme') || 'system',
                set(theme) {
                    this.current = theme;
                    localStorage.setItem('theme', theme);
                    this.apply();
                },
                apply() {
                    const isDark =
                        this.current === 'dark' ||
                        (this.current === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    document.documentElement.classList.toggle('dark', isDark);
                    document.getElementById('theme-color').setAttribute('content', isDark ? '#1a202c' : '#ffffff');
                },
                init() {
                    this.apply();
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.current === 'system') {
                            this.apply();
                        }
                    });
                },
            });

            Alpine.store('fontSize', {
                current: localStorage.getItem('fontSize') || 'normal',
                set(size) {
                    this.current = size;
                    localStorage.setItem('fontSize', size);
                    this.apply();
                },
                apply() {
                    document.body.classList.remove('text-sm', 'text-base', 'text-lg');
                    switch (this.current) {
                        case 'small':
                            document.body.classList.add('text-sm');
                            break;
                        case 'large':
                            document.body.classList.add('text-lg');
                            break;
                        default:
                            document.body.classList.add('text-base');
                    }
                },
                init() {
                    if (!localStorage.getItem('fontSize')) {
                        this.set('normal');
                    }
                    this.apply();
                },
            });

            Alpine.store('chaosIndex', {
                score: 0,
                summary: '',
                getBucketDescription() {
                    const score = this.score;
                    if (score >= 0 && score <= 20) {
                        return '0-20: Peaceful and calm world. Yay!';
                    } else if (score >= 21 && score <= 40) {
                        return '21-40: Emerging challenges, manageable tensions.';
                    } else if (score >= 41 && score <= 60) {
                        return '41-60: Growing global issues, but hope persists.';
                    } else if (score >= 61 && score <= 80) {
                        return '61-80: Multiple crises, increasing instability.';
                    } else if (score >= 81 && score <= 100) {
                        return '81-100: Severe global turmoil, widespread impact.';
                    } else {
                        return 'Undefined score range';
                    }
                },
            });

            Alpine.store('storyCount', {
                current: parseInt(localStorage.getItem('storyCount')) || 10,
                set(count) {
                    this.current = count;
                    localStorage.setItem('storyCount', count);
                },
                init() {
                    if (this.current < 3) this.current = 3;
                    if (this.current > 12) this.current = 12;
                },
            });

            Alpine.store('categories', {
                order: [],
                enabled: [],
                init() {
                    const savedOrder = JSON.parse(localStorage.getItem('categoryOrder'));
                    const savedEnabled = JSON.parse(localStorage.getItem('enabledCategories'));
                    if (savedOrder) {
                        this.order = savedOrder.filter((cat) => cat != null && cat !== undefined && cat !== '');
                    }
                    if (savedEnabled) {
                        // Reorder enabled categories to match the order in categoryOrder and filter out null values
                        this.enabled = this.order.filter(
                            (cat) => cat != null && cat !== undefined && cat !== '' && savedEnabled.includes(cat)
                        );
                    }
                    // Save the cleaned up enabled categories
                    localStorage.setItem('enabledCategories', JSON.stringify(this.enabled));
                },
                updateOrder(newOrder) {
                    this.order = newOrder.filter((cat) => cat !== null && cat !== undefined && cat !== '');
                    // Don't modify enabled categories here - let the Sortable handler manage that
                    localStorage.setItem('categoryOrder', JSON.stringify(this.order));
                    localStorage.setItem('enabledCategories', JSON.stringify(this.enabled));
                },
                toggle(category) {
                    const index = this.enabled.indexOf(category);
                    if (index > -1) {
                        if (this.enabled.length > 1) {
                            this.enabled.splice(index, 1);
                        }
                    } else {
                        // When enabling a category, insert it in the correct position according to order
                        const orderIndex = this.order.indexOf(category);
                        const insertIndex = this.enabled.findIndex((cat) => this.order.indexOf(cat) > orderIndex);
                        if (insertIndex === -1) {
                            this.enabled.push(category);
                        } else {
                            this.enabled.splice(insertIndex, 0, category);
                        }
                    }
                    localStorage.setItem('enabledCategories', JSON.stringify(this.enabled));
                },
                isEnabled(category) {
                    return this.enabled.includes(category);
                },
            });

            Alpine.store('imageGallery', {
                swiper: null,
                isOpen: false,
                images: [],
                open(images) {
                    this.images = images;
                    this.isOpen = true;
                    document.body.classList.add('overflow-hidden');
                    setTimeout(() => {
                        this.swiper = initializeSwiper('.swiper-container');
                    }, 0);
                },
                close() {
                    this.isOpen = false;
                    document.body.classList.remove('overflow-hidden');
                    if (this.swiper) {
                        this.swiper.destroy();
                        this.swiper = null;
                    }
                },
            });

            Alpine.store('settings', {
                isOpen: false,
                open() {
                    this.isOpen = true;
                    document.body.classList.add('overflow-hidden');
                },
                close() {
                    this.isOpen = false;
                    document.body.classList.remove('overflow-hidden');
                },
            });

            Alpine.store('components', {
                list: [
                    // Core Content Components
                    { id: 'summary', name: 'Summary', enabled: true },
                    { id: 'location', name: 'Location', enabled: true },
                    { id: 'main_image', name: 'Main Image', enabled: true },
                    { id: 'highlights', name: 'Highlights', enabled: true },

                    // Media Components
                    { id: 'quote', name: 'Quote', enabled: true },
                    { id: 'additional_image', name: 'Additional Image', enabled: true },

                    // Context Components
                    { id: 'perspectives', name: 'Perspectives', enabled: true },
                    {
                        id: 'geopolitical_context',
                        name: 'Geopolitical Context',
                        enabled: true,
                    },
                    {
                        id: 'historical_background',
                        name: 'Historical Background',
                        enabled: true,
                    },
                    {
                        id: 'humanitarian_impact',
                        name: 'Humanitarian Impact',
                        enabled: true,
                    },
                    {
                        id: 'international_reactions',
                        name: 'International Reactions',
                        enabled: true,
                    },

                    // Technical Components
                    {
                        id: 'technical_details',
                        name: 'Technical Details',
                        enabled: true,
                    },
                    {
                        id: 'technical_specifications',
                        name: 'Technical Specifications',
                        enabled: true,
                    },
                    {
                        id: 'design_principles',
                        name: 'Design Principles',
                        enabled: true,
                    },
                    {
                        id: 'user_experience_impact',
                        name: 'User Experience Impact',
                        enabled: true,
                    },

                    // Business & Performance
                    { id: 'business_angle', name: 'Business Angle', enabled: true },
                    {
                        id: 'gaming_industry_impact',
                        name: 'Gaming Industry Impact',
                        enabled: true,
                    },
                    {
                        id: 'performance_statistics',
                        name: 'Performance Statistics',
                        enabled: true,
                    },
                    { id: 'league_standings', name: 'League Standings', enabled: true },

                    // Additional Information
                    { id: 'timeline', name: 'Timeline', enabled: true },
                    { id: 'sources', name: 'Sources', enabled: true },
                    { id: 'future_outlook', name: 'Future Outlook', enabled: true },
                    {
                        id: 'scientific_significance',
                        name: 'Scientific Significance',
                        enabled: true,
                    },
                    { id: 'travel_advisory', name: 'Travel Advisory', enabled: true },
                    { id: 'did_you_know', name: 'Did You Know', enabled: true },
                    { id: 'action_items', name: 'Action Items', enabled: true },
                ],
                init() {
                    const stored = localStorage.getItem('storyComponents');
                    if (stored) {
                        this.list = JSON.parse(stored);
                    }
                },
                toggle(id) {
                    const component = this.list.find((c) => c.id === id);
                    if (component) {
                        component.enabled = !component.enabled;
                        this.save();
                    }
                },
                save() {
                    localStorage.setItem('storyComponents', JSON.stringify(this.list));
                },
            });
        });
        function lockScroll() {
            document.body.style.overflow = 'hidden';
        }

        function unlockScroll() {
            document.body.style.overflow = '';
        }

        function fetchChaosIndex() {
            // Disabled chaos index loading
            return;
        }

        function generateArticleId(category, clusterNumber) {
            return `${category.toLowerCase()}-${clusterNumber}`;
        }

        function updateUrlWithArticleId(articleId) {
            const url = new URL(window.location);
            if (articleId) {
                url.searchParams.set('article', articleId);
            } else {
                url.searchParams.delete('article');
                // If there are no more parameters, remove the '?' entirely
                if (Array.from(url.searchParams).length === 0) {
                    window.history.pushState({}, '', window.location.pathname);
                    return;
                }
            }
            window.history.pushState({}, '', url);
        }

        function getArticleIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('article');
        }

        function formatTimeSince(timestamp) {
            const diff = Math.floor(Date.now() / 1000 - timestamp);
            if (diff < 60) {
                return `Updated ${diff} sec ago`;
            } else if (diff < 3600) {
                const mins = Math.floor(diff / 60);
                return `Updated ${mins} ${mins === 1 ? 'min' : 'mins'} ago`;
            } else {
                const hours = Math.floor(diff / 3600);
                return `Updated ${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
            }
        }

        function handleWikiLink(event) {
            const link = event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]');
            if (link) {
                event.preventDefault();
                const title = decodeURIComponent(link.getAttribute('href').split('/').pop());
                const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;

                fetch(apiUrl)
                    .then((response) => response.json())
                    .then((data) => {
                        showPopup(data, link);
                    })
                    .catch((error) => {
                        console.error('Error fetching Wikipedia summary:', error);
                    });
            }
        }

        function showPopup(data, link) {
            const popup = document.getElementById('wikipedia-popup');
            const popupContent = document.getElementById('wikipedia-popup-content');
            const popupImage = document.getElementById('wikipedia-popup-image');
            const popupLayout = document.getElementById('wikipedia-popup-layout');
            const closeButton = document.getElementById('wikipedia-popup-close');

            popupContent.textContent = data.extract;

            if (data.thumbnail) {
                popupImage.src = data.thumbnail.source;
                popupImage.style.display = 'block';
            } else {
                popupImage.style.display = 'none';
            }

            popupLayout.classList.remove('flex-row');
            popupLayout.classList.add('flex-col');
            popupImage.classList.add('mb-4');
            popupImage.classList.remove('mr-4');
            popupImage.style.width = '100%';
            popupImage.style.height = 'auto';
            popupImage.style.objectFit = 'scale-down';

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                popup.style.position = 'fixed';
                popup.style.left = '0';
                popup.style.right = '0';
                popup.style.top = '0';
                popup.style.width = '100%';
                popup.style.maxWidth = '100%';
                popup.style.height = '80vh';
                popup.style.maxHeight = '80vh';
                popup.style.margin = '0';
                popup.style.borderRadius = '0';
                popup.style.overflowY = 'auto';
                closeButton.style.display = 'block';
            } else {
                const rect = link.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const popupWidth = 400;
                const popupHeight = 400;

                let leftPosition = rect.left + window.scrollX;
                let topPosition = rect.bottom + window.scrollY;

                if (leftPosition + popupWidth > viewportWidth) {
                    leftPosition = Math.max(viewportWidth - popupWidth - 10, 0);
                }

                if (topPosition + popupHeight > viewportHeight + window.scrollY) {
                    topPosition = Math.max(rect.top + window.scrollY - popupHeight, window.scrollY);
                }

                popup.style.position = 'absolute';
                popup.style.left = `${leftPosition}px`;
                popup.style.top = `${topPosition}px`;
                popup.style.width = `${popupWidth}px`;
                popup.style.height = `${popupHeight}px`;
                popup.style.borderRadius = '0.5rem';
                closeButton.style.display = 'none';
            }

            popup.style.display = 'block';
        }

        function openImageGallery(images) {
            Alpine.store('imageGallery').open(images);
        }
        document.addEventListener('alpine:init', () => {
            Alpine.data('kiteApp', () => ({
                stories: [],
                expandedStory: null,
                initialLoading: true,
                mediaData: [],
                isScrolling: false,
                readStories: JSON.parse(localStorage.getItem('readStories') || '{}'),
                availableCategories: [],
                currentCategory: '',
                timestamp: 0,
                readCount: 0,
                dateClickCount: 0,
                allStories: {},
                onThisDayEvents: [],
                showIntro: !Alpine.store('intro').shown && !getArticleIdFromUrl(),
                chaosScore: 0,
                chaosSummary: '',
                viewMode: 'list',
                sortableInstance: null,
                loadingProgress: 0,
                getLastUpdated() {
                    return formatTimeSince(this.timestamp);
                },
                openMaps(location) {
                    const encodedLocation = encodeURIComponent(location);
                    const appleUrl = `maps://maps.apple.com/?q=${encodedLocation}`;
                    const googleUrl = `maps:?q=${encodedLocation}`;
                    const googleWebUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;

                    const isMacOSOrIOS = /Mac|iPhone|iPad|iPod/.test(navigator.platform);

                    if (isMacOSOrIOS) {
                        window.location.href = appleUrl;

                        setTimeout(() => {
                            if (document.hidden) return;
                            window.location.href = googleUrl;
                        }, 500);
                    } else {
                        window.location.href = googleUrl;

                        setTimeout(() => {
                            if (document.hidden) return;
                            window.location.href = googleWebUrl;
                        }, 500);
                    }
                },
                async init() {
                    Alpine.store('categories').init();

                    // Load media data
                    try {
                        const response = await fetch('{{ static_path }}/media_data.json');
                        if (response.ok) {
                            this.mediaData = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading media data:', error);
                        this.mediaData = [];
                    }

                    this.fetchCategories()
                        .then(() => {
                            return this.fetchAllStories();
                        })
                        .then(() => {
                            const storedOrder = Alpine.store('categories').order || [];
                            const storedEnabled = Alpine.store('categories').enabled || [];
                            const allCategoryNames = this.availableCategories.map((cat) => cat.name);

                            // For new users (no stored order or enabled categories), set defaults
                            if (
                                !storedOrder ||
                                storedOrder.length === 0 ||
                                !storedEnabled ||
                                storedEnabled.length === 0
                            ) {
                                const defaultCategories = [
                                    'World',
                                    'USA',
                                    'Business',
                                    'Technology',
                                    'Science',
                                    'Sports',
                                    'Gaming',
                                    'Bay Area',
                                ];
                                Alpine.store('categories').order = allCategoryNames;
                                Alpine.store('categories').enabled = defaultCategories.filter((name) =>
                                    allCategoryNames.includes(name)
                                );
                                this.currentCategory = 'World';
                            } else {
                                // For existing users, update order and enabled categories
                                const newCategories = allCategoryNames.filter(
                                    (name) => !storedOrder.includes(name)
                                );
                                Alpine.store('categories').order = storedOrder.concat(newCategories);

                                // Remove categories from order that no longer exist
                                Alpine.store('categories').order = Alpine.store('categories').order.filter((name) =>
                                    allCategoryNames.includes(name)
                                );

                                // Keep their enabled categories that still exist
                                Alpine.store('categories').enabled = storedEnabled.filter((name) =>
                                    allCategoryNames.includes(name)
                                );
                            }

                            // Rebuild availableCategories according to the updated order
                            this.availableCategories = Alpine.store('categories')
                                .order.map((name) => this.availableCategories.find((cat) => cat.name === name))
                                .filter((cat) => cat);

                            // Save the updated order and enabled categories back to localStorage
                            localStorage.setItem('categoryOrder', JSON.stringify(Alpine.store('categories').order));
                            localStorage.setItem(
                                'enabledCategories',
                                JSON.stringify(Alpine.store('categories').enabled)
                            );

                            // Set current category to the first enabled category
                            const firstEnabledCategory = Alpine.store('categories').enabled[0];
                            if (firstEnabledCategory) {
                                this.currentCategory = firstEnabledCategory;
                            }

                            this.updateCategoryDropdown();

                            const articleId = getArticleIdFromUrl();
                            if (articleId) {
                                this.openSharedArticle(articleId);
                            }
                        });

                    Alpine.store('theme').init();
                    Alpine.store('fontSize').init();
                    Alpine.store('storyCount').init();

                    fetchChaosIndex();

                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },
                fetchCategories() {
                    return fetch(`https://corsproxy.io/?https://kite.kagi.com/kite.json?${timestamp}`)
                        .then((response) => response.json())
                        .then((data) => {
                            this.availableCategories = data.categories;
                            this.timestamp = data.timestamp;
                        });
                },
                fetchAllStories() {
                    this.initialLoading = true;
                    this.allStories = {};
                    this.totalReadCount = 0;
                    const totalCategories = this.availableCategories.length;
                    let loadedCategories = 0;

                    const fetchPromises = this.availableCategories.map((category) =>
                        fetch(`https://corsproxy.io/?https://kite.kagi.com/${category.file}?${timestamp}`)
                            .then((response) => response.json())
                            .then((data) => {
                                if (category.name === 'OnThisDay') {
                                    this.onThisDayEvents = data.events;
                                } else {
                                    this.allStories[category.name] = {
                                        clusters: data.clusters,
                                        readCount: data.read,
                                    };
                                    this.totalReadCount += data.read;
                                }
                                loadedCategories++;
                                this.loadingProgress = Math.round((loadedCategories / totalCategories) * 100);
                            })
                    );

                    return Promise.all(fetchPromises)
                        .then(() => {
                            this.changeCategory();
                            this.initialLoading = false;
                        })
                        .catch((error) => {
                            console.error('Error fetching stories:', error);
                            this.initialLoading = false;
                        });
                },
                initSortable() {
                    const el = document.getElementById('enabled-categories');
                    if (el) {
                        this.sortableInstance = new Sortable(el, {
                            animation: 150,
                            ghostClass: 'bg-blue-600',
                            forceFallback: false,
                            fallbackClass: 'sortable-fallback',
                            setData: function () {
                                return false;
                            },
                            onStart: (evt) => {
                                evt.from.setAttribute('x-skip', '');
                            },
                            onEnd: (evt) => {
                                evt.from.removeAttribute('x-skip');

                                const newEnabledOrder = Array.from(el.children)
                                    .map((item) => item.dataset.category)
                                    .filter(Boolean);

                                const categoriesStore = Alpine.store('categories');

                                categoriesStore.enabled = [...newEnabledOrder];

                                const currentOrder = categoriesStore.order;
                                const newFullOrder = [
                                    ...newEnabledOrder,
                                    ...currentOrder.filter((cat) => !newEnabledOrder.includes(cat)),
                                ];
                                categoriesStore.order = [...newFullOrder];

                                localStorage.setItem('enabledCategories', JSON.stringify(newEnabledOrder));
                                localStorage.setItem('categoryOrder', JSON.stringify(newFullOrder));

                                this.availableCategories = newFullOrder
                                    .map((catName) => this.availableCategories.find((cat) => cat.name === catName))
                                    .filter(Boolean);

                                this.$nextTick(() => {
                                    const sortableGrid = document.getElementById('enabled-categories');
                                    if (sortableGrid) {
                                        const newHTML = newEnabledOrder
                                            .map(
                                                (catName) => `
                                        <div data-category="${catName}" 
                                                class="bg-blue-500 text-white px-4 py-3 rounded-md text-sm font-medium cursor-pointer flex items-center justify-center min-h-[48px]">
                                            <span>${catName}</span>
                                        </div>
                                    `
                                            )
                                            .join('');
                                        sortableGrid.innerHTML = newHTML;
                                    }

                                    const categoryTabs = document.querySelector('.category-tabs');
                                    if (categoryTabs) {
                                        Alpine.morph(categoryTabs, categoryTabs.outerHTML);
                                    }

                                    this.sortableInstance.destroy();
                                    this.initSortable();
                                });
                            },
                        });
                    }
                },
                handleCategoryClick(category) {
                    const categoriesStore = Alpine.store('categories');
                    if (categoriesStore.enabled.length > 1) {
                        categoriesStore.toggle(category.name);
                        this.updateCategoryDropdown();
                        this.changeCategory();
                    }
                },
                updateCategoryDropdown() {
                    const select = document.getElementById('category-select');
                    if (!select) {
                        return;
                    }

                    const enabledCategories = Alpine.store('categories').enabled;

                    while (select.firstChild) {
                        select.removeChild(select.firstChild);
                    }

                    // Use the stored order for enabled categories
                    enabledCategories.forEach((catName) => {
                        if (catName) {
                            const option = document.createElement('option');
                            option.value = catName;
                            option.textContent = catName === 'OnThisDay' ? 'Today in History' : catName;
                            select.appendChild(option);
                        }
                    });

                    // Ensure current category is the first enabled one
                    const firstEnabledCategory = enabledCategories[0];
                    if (firstEnabledCategory && firstEnabledCategory !== this.currentCategory) {
                        this.currentCategory = firstEnabledCategory;
                        this.changeCategory();
                    }
                },
                closeIntro() {
                    this.showIntro = false;
                    Alpine.store('intro').set(true);
                },
                toggleStory(story, index) {
                    if (this.expandedStory === story) {
                        // Collapse the story
                        story.expanded = false;
                        this.expandedStory = null;
                        updateUrlWithArticleId('');
                        story.showSources = false;
                        // Do not call scrollToStory when collapsing
                    } else {
                        if (this.expandedStory && this.expandedStory !== story) {
                            this.expandedStory.expanded = false;
                            this.expandedStory.showSources = false;
                        }
                        // Expand the story
                        this.readStories[story.title] = true;
                        localStorage.setItem('readStories', JSON.stringify(this.readStories));
                        story.expanded = true;
                        this.expandedStory = story;
                        const articleId = generateArticleId(this.currentCategory, story.cluster_number);
                        updateUrlWithArticleId(articleId);
                        story.showSources = false;
                        // Call scrollToStory after expanding
                        this.$nextTick(() => {
                            this.scrollToStory(index);
                        });
                    }
                },
                closeStory(story, index) {
                    // Collapse the story
                    story.expanded = false;
                    this.expandedStory = null;
                    updateUrlWithArticleId('');
                    story.showSources = false;
                    // Scroll to the collapsed story
                    this.$nextTick(() => {
                        this.scrollToStory(index);
                    });
                },
                scrollToStory(index) {
                    setTimeout(() => {
                        const storyElement = document.getElementById('story-' + index);
                        if (storyElement) {
                            const navHeight = document.querySelector('.sticky').offsetHeight;
                            const yOffset = -navHeight;
                            const y = storyElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                            window.scrollTo({ top: y, behavior: 'smooth' });
                        }
                    }, 100);
                },
                openSharedArticle(articleId) {
                    const [category, clusterNumber] = articleId.split('-');
                    // Handle multi-word categories by capitalizing each word
                    const targetCategory = category
                        .split('+')
                        .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');

                    // Wait for stories to be loaded
                    const checkAndOpenStory = () => {
                        if (this.allStories[targetCategory]) {
                            // Set current category first
                            this.currentCategory = targetCategory;

                            // Make sure the category is enabled
                            if (!Alpine.store('categories').enabled.includes(targetCategory)) {
                                Alpine.store('categories').toggle(targetCategory);
                            }

                            // Update category dropdown and UI
                            this.updateCategoryDropdown();
                            this.changeCategory();

                            // Find and open the story
                            const story = this.allStories[targetCategory].clusters.find(
                                (s) => s.cluster_number === parseInt(clusterNumber)
                            );

                            if (story) {
                                // Ensure the story is in the visible stories array
                                this.stories = this.allStories[targetCategory].clusters.slice(
                                    0,
                                    this.$store.storyCount.current
                                );

                                // Expand the story
                                story.expanded = true;
                                this.expandedStory = story;

                                // Scroll to the story after a short delay to ensure DOM is updated
                                this.$nextTick(() => {
                                    const storyIndex = this.stories.findIndex(
                                        (s) => s.cluster_number === story.cluster_number
                                    );
                                    if (storyIndex !== -1) {
                                        setTimeout(() => {
                                            this.scrollToStory(storyIndex);
                                        }, 200);
                                    }
                                });
                            } else {
                                console.warn(
                                    `Story with cluster number ${clusterNumber} not found in ${targetCategory}`
                                );
                            }
                        } else {
                            // If stories aren't loaded yet, try again in 100ms
                            setTimeout(checkAndOpenStory, 100);
                        }
                    };

                    // Start checking for stories
                    checkAndOpenStory();
                },
                shareArticle(story) {
                    const articleId = generateArticleId(this.currentCategory, story.cluster_number);
                    const url = new URL(window.location);
                    url.searchParams.set('article', articleId);

                    if (navigator.share) {
                        navigator
                            .share({
                                title: story.title,
                                text: 'Check out this story:',
                                url: url.toString(),
                            })
                            .catch(() => {
                                navigator.clipboard.writeText(url.toString());
                            });
                    } else {
                        navigator.clipboard.writeText(url.toString());
                    }
                },
                changeCategory() {
                    // Close any expanded story
                    if (this.expandedStory) {
                        this.expandedStory.expanded = false;
                        this.expandedStory = null;
                        updateUrlWithArticleId('');
                    }

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    if (this.availableCategories.length > 0) {
                        let enabledCategories = Alpine.store('categories').enabled;

                        if (enabledCategories.length === 0) {
                            this.availableCategories.forEach((cat) => Alpine.store('categories').toggle(cat.name));
                            enabledCategories = Alpine.store('categories').enabled;
                        }

                        // Ensure current category is valid and load its stories
                        if (!enabledCategories.includes(this.currentCategory)) {
                            this.currentCategory = enabledCategories[0];
                        }

                        if (this.currentCategory === 'OnThisDay') {
                            this.stories = this.onThisDayEvents;
                        } else if (this.allStories[this.currentCategory]) {
                            const allClusters = this.allStories[this.currentCategory].clusters;
                            const unreadClusters = allClusters.filter((story) => !this.readStories[story.title]);
                            const readClusters = allClusters.filter((story) => this.readStories[story.title]);

                            // Take unread stories up to the limit
                            const unreadToShow = unreadClusters.slice(0, this.$store.storyCount.current);

                            // Combine unread and read stories
                            this.stories = [...unreadToShow, ...readClusters];
                            this.readCount = this.allStories[this.currentCategory].readCount;
                        }
                    }
                },
            }));
        });

        document.addEventListener('pointerover', (event) => {
            const link = event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]');
            if (link) {
                if (event.pointerType === 'touch' || window.innerWidth <= 768) {
                    event.preventDefault();
                }
                const title = decodeURIComponent(link.getAttribute('href').split('/').pop());
                const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                fetch(apiUrl)
                    .then((response) => response.json())
                    .then((data) => {
                        showPopup(data, link);
                    })
                    .catch((error) => {
                        console.error('Error fetching Wikipedia summary:', error);
                    });
            }
        });

        document.addEventListener('pointerout', (event) => {
            if (
                !event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]') &&
                !event.target.closest('#wikipedia-popup')
            ) {
                document.getElementById('wikipedia-popup').style.display = 'none';
            }
        });
    </script>
</head>

<body
    class="min-h-screen bg-white dark:bg-dark-bg text-black dark:text-dark-text"
    x-data="Object.assign(kiteApp(), sourceOverlay())"
    x-bind:class="$store.fontSize.current === 'extra-small' ? 'text-xs' : $store.fontSize.current === 'small' ? 'text-sm' : $store.fontSize.current === 'large' ? 'text-lg' : 'text-base'"
>
    <!-- Wikipedia Popup -->
    <div
        id="wikipedia-popup"
        class="fixed z-50 bg-white dark:bg-gray-800 shadow-xl p-4 hidden overflow-y-auto"
        style="max-width: 600px; max-height: 80vh"
    >
        <button
            id="wikipedia-popup-close"
            onclick="document.getElementById('wikipedia-popup').style.display='none'"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div id="wikipedia-popup-layout" class="flex flex-col h-full">
            <img
                id="wikipedia-popup-image"
                class="w-full object-contain mb-4 rounded"
                style="max-height: 200px; max-width: 100%; height: auto; display: none"
                alt="Article image"
            />
            <div class="flex-1">
                <div id="wikipedia-popup-content"></div>
            </div>
        </div>
    </div>
    <!-- Splash Screen -->
    <div
        x-show="initialLoading"
        x-transition
        class="fixed inset-0 flex items-center justify-center bg-white dark:bg-dark-bg z-50"
    >
        <div class="text-center">
            <img
                :src="$store.theme.current === 'dark' ? '{{ static_path }}/svg/kite_dark.svg' : '{{ static_path }}/svg/kite.svg'"
                alt="Kite Logo"
                class="w-24 h-24 mx-auto mb-4 animate-bounce"
            />
            <h1 class="text-2xl font-bold text-gray-800 dark:text-dark-text mb-2">Kite</h1>
            <p class="text-xl text-gray-600 dark:text-gray-400">News. Elevated.</p>
            <p
                x-text="loadingProgress > 20 ? loadingProgress + '%' : ''"
                class="mt-4 text-sm text-gray-500 dark:text-gray-400 min-h-[1.5rem]"
            ></p>
        </div>
    </div>

    <!-- About Screen -->
    <div
        x-show="showIntro && !getArticleIdFromUrl()"
        x-cloak
        class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50 overflow-y-auto"
    >
        <div class="w-full h-full max-w-3xl mx-auto p-4 sm:p-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-8">
                <div class="flex justify-between items-start mb-8">
                    <div class="w-full">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">About Kite</h1>
                        <p class="text-gray-600 dark:text-gray-300">A news app by Kagi</p>
                    </div>
                </div>

                <div class="space-y-6 text-gray-700 dark:text-gray-300">
                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">What is Kite?</h2>
                        <p class="mb-4">
                            Kite is a news app designed for people who want to stay informed without getting
                            overwhelmed. We provide thrice-daily updates of the most important news stories, from
                            carefully curated sources and summarized by advanced language models to give you the
                            essential information you need.
                        </p>
                    </section>
                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
                            Understanding our approach
                        </h2>
                        <p class="mb-4 text-gray-700 dark:text-gray-300">
                            Kite aggregates information from thousands of global sources, acknowledging that every
                            news outlet has its own perspective and potential biases.
                        </p>
                        <p class="mb-4 text-gray-700 dark:text-gray-300">
                            While individual sources may have their own agendas, Kite itself maintains neutrality
                            by:
                        </p>
                        <ul class="list-disc pl-5 mb-4 text-gray-700 dark:text-gray-300">
                            <li>Cross-referencing facts across multiple sources worldwide</li>
                            <li>Presenting verified information that appears consistently across sources</li>
                            <li>Acknowledging different perspectives when significant discrepancies exist</li>
                            <li>Letting readers form their own informed opinions</li>
                        </ul>
                        <p class="mb-4 text-gray-700 dark:text-gray-300">
                            Our goal is to provide a comprehensive global view of events, considering all relevant
                            viewpoints while remaining factual and opinion-free in our summaries.
                        </p>
                        <p class="mb-4 text-gray-700 dark:text-gray-300">
                            Think of Kite as having access to every newspaper in the world, distilled into
                            essential, verified information.
                        </p>
                    </section>

                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Core Principles</h2>
                        <ul class="space-y-2">
                            <li>• Updated only three times per day - no endless scrolling</li>
                            <li>• Facts and perspectives, opinion-free</li>
                            <li>• Zero tracking, zero ads</li>
                            <li>• Pure signal, no noise</li>
                            <li>• Quality over quantity</li>
                            <li>• Complete news diet in 5 minutes</li>
                        </ul>
                    </section>

                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Updates</h2>
                        <p>
                            Stories are updated three times per day. This helps maintain a balanced news diet
                            without constant interruptions. Click the date on top of the page to check when was the
                            last update.
                        </p>
                    </section>

                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Customization</h2>
                        <p>
                            Use Kite settings to reorder and toggle categories. Have an idea for a feture or news
                            category? Most of Kite is open source including th web app and community curated feeds.
                            Feel free to
                            <a
                                class="text-blue-600 dark:text-blue-400 hover:underline"
                                href="https://github.com/kagisearch/kite-public"
                            >
                                contribute
                            </a>
                            .
                        </p>
                    </section>

                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Privacy</h2>
                        <p>
                            Kite is committed to user privacy. We don't track you, we don't show ads, and we don't
                            collect any personal information. Your news reading habits are your business.
                        </p>
                    </section>

                    <section>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Contact</h2>
                        <p>
                            For feedback, please use
                            <a
                                class="text-blue-600 dark:text-blue-400 hover:underline"
                                href="https://kagifeedback.org"
                            >
                                Kagi Feedback
                            </a>
                            . For support,
                            <a
                                href="mailto:support@kagi.com"
                                class="text-blue-600 dark:text-blue-400 hover:underline"
                            >
                                support@kagi.com
                            </a>
                            .
                        </p>
                    </section>

                    <div class="mt-8 flex justify-center">
                        <button
                            @click="closeIntro()"
                            class="px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main x-show="!initialLoading && !showIntro" x-cloak>
        <div class="container mx-auto px-4 py-8 max-w-[732px]">
            <header class="flex justify-between items-center mb-1">
                <div class="flex items-center">
                    <img
                        :src="$store.theme.current === 'dark' ? '{{ static_path }}/svg/kite_dark.svg' : '{{ static_path }}/svg/kite.svg'"
                        alt="Kite News Logo"
                        class="w-8 h-8 mr-2"
                        @click="$event.target.classList.add('kite-logo'); setTimeout(() => $event.target.classList.remove('kite-logo'), 3000)"
                    />
                    <a
                        href="javascript:void(0)"
                        @click="window.location.href = window.location.pathname"
                        class="flex items-center"
                    >
                        <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">Kite</h1>
                    </a>
                </div>
                <div
                    class="text-gray-600 dark:text-gray-400 cursor-pointer"
                    x-data="{ dateClickCount: 0 }"
                    @click="dateClickCount = (dateClickCount + 1) % 3"
                    x-text="dateClickCount === 0 ? new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(new Date())                                                                                                                                                                        
                            : dateClickCount === 1 ? getLastUpdated()                                                                                                                                                                                                                                                                                           
                            : `${totalReadCount} stories read`"
                ></div>
                <div class="flex items-center">
                    <button @click="$store.settings.open()" title="Settings" class="ml-2">
                        <img
                            src="{{ static_path }}/svg/gear.svg"
                            alt=""
                            class="h-6 w-6 text-gray-600 dark:text-gray-400 dark:invert"
                            aria-hidden="true"
                        />
                    </button>
                </div>
            </header>
            <div class="sticky top-0 bg-white dark:bg-dark-bg py-2" role="navigation">
                <div
                    class="category-tabs"
                    role="tablist"
                    aria-label="News categories"
                    @touchstart="isScrolling = true"
                    @touchend="isScrolling = false"
                >
                    <template
                        x-for="category in availableCategories.filter(cat => $store.categories.isEnabled(cat.name))"
                        :key="category.name"
                    >
                        <div
                            role="tab"
                            :aria-selected="currentCategory === category.name"
                            :aria-controls="'category-' + category.name"
                            class="category-tab"
                            :class="{ 'active': currentCategory === category.name }"
                            @click="if (!isScrolling) { currentCategory = category.name; changeCategory(); updateUrlWithArticleId(''); }"
                            x-text="category.name === 'OnThisDay' ? 'Today in History' : category.name"
                        ></div>
                    </template>
                </div>
            </div>
            <div
                x-show="currentCategory === 'World' && $store.chaosIndex.score > 0"
                class="mb-4 flex justify-between items-center"
            >
                <div x-data="{ showChaosPopup: false }" class="relative">
                    <div
                        @click="setTimeout(() => showChaosPopup = true, 100)"
                        class="px-3 py-1.5 flex items-center justify-center cursor-pointer rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200"
                        title="Turbulence meter"
                    >
                        <span x-text="$store.chaosIndex.score" class="text-sm font-medium"></span>
                    </div>
                    <div
                        x-show="showChaosPopup"
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform scale-90"
                        x-transition:enter-end="opacity-100 transform scale-100"
                        x-transition:leave="transition ease-in duration-300"
                        x-transition:leave-start="opacity-100 transform scale-100"
                        x-transition:leave-end="opacity-0 transform scale-90"
                        @click.away="showChaosPopup = false"
                        @keydown.escape.window="showChaosPopup = false"
                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
                    >
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                            <button
                                @click="showChaosPopup = false"
                                class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                            >
                                <svg
                                    class="w-6 h-6"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"
                                    ></path>
                                </svg>
                            </button>
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
                                World turbulence meter
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-8" x-text="getLastUpdated()"></p>
                            <!-- Updated Progress Bar with Segments and Notches -->
                            <div class="relative mb-4">
                                <!-- Chaos Index Score Display -->
                                <div class="absolute -top-6 left-0 right-0">
                                    <span
                                        x-text="$store.chaosIndex.score"
                                        :style="{ left: $store.chaosIndex.score + '%', transform: 'translateX(-50%)' }"
                                        style="position: absolute"
                                    >
                                        50
                                    </span>
                                </div>
                                <div
                                    class="relative w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden"
                                >
                                    <!-- Segmented Background -->
                                    <div class="absolute top-0 left-0 h-4 w-full rounded-full overflow-hidden flex">
                                        <div class="h-4 w-1/5" style="background-color: #4caf50"></div>
                                        <!-- 0-20 -->
                                        <div class="h-4 w-1/5" style="background-color: #8bc34a"></div>
                                        <!-- 21-40 -->
                                        <div class="h-4 w-1/5" style="background-color: #ffeb3b"></div>
                                        <!-- 41-60 -->
                                        <div class="h-4 w-1/5" style="background-color: #ff9800"></div>
                                        <!-- 61-80 -->
                                        <div class="h-4 w-1/5" style="background-color: #f44336"></div>
                                        <!-- 81-100 -->
                                    </div>

                                    <!-- Notches -->
                                    <div class="absolute top-0 left-[20%] w-0.5 h-4 bg-white"></div>
                                    <div class="absolute top-0 left-[40%] w-0.5 h-4 bg-white"></div>
                                    <div class="absolute top-0 left-[60%] w-0.5 h-4 bg-white"></div>
                                    <div class="absolute top-0 left-[80%] w-0.5 h-4 bg-white"></div>

                                    <!-- Score Notch -->
                                    <div
                                        class="absolute top-0 w-1 h-4 bg-gray-500"
                                        :style="{ left: $store.chaosIndex.score + '%' }"
                                        :aria-valuenow="$store.chaosIndex.score"
                                        aria-valuemin="0"
                                        aria-valuemax="100"
                                    ></div>
                                </div>
                                <!-- Labels -->
                                <div class="absolute -bottom-5 left-0 text-xs text-gray-700 dark:text-gray-300">
                                    0
                                </div>
                                <div
                                    class="absolute -bottom-5 left-[20%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300"
                                >
                                    20
                                </div>
                                <div
                                    class="absolute -bottom-5 left-[40%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300"
                                >
                                    40
                                </div>
                                <div
                                    class="absolute -bottom-5 left-[60%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300"
                                >
                                    60
                                </div>
                                <div
                                    class="absolute -bottom-5 left-[80%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300"
                                >
                                    80
                                </div>
                                <div class="absolute -bottom-5 right-0 text-xs text-gray-700 dark:text-gray-300">
                                    100
                                </div>
                            </div>

                            <!-- Current Bucket Description -->
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-8">
                                <span class="font-semibold text-gray-800 dark:text-gray-200">
                                    <span
                                        x-text="$store.chaosIndex.getBucketDescription().split(':')[0] + ':'"
                                    ></span>
                                </span>
                                <span x-text="$store.chaosIndex.getBucketDescription().split(':')[1].trim()"></span>
                            </p>

                            <!-- Chaos Summary -->
                            <p
                                class="text-gray-600 dark:text-gray-400 mt-4"
                                x-html="$store.chaosIndex.summary.replace(/\n/g, '<br>')"
                            ></p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button
                        @click="viewMode = 'list'"
                        :class="{'text-blue-500': viewMode === 'list', 'text-gray-500': viewMode !== 'list'}"
                        aria-label="Switch to list view"
                        title="List view"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 10h16M4 14h16M4 18h16"
                            />
                        </svg>
                    </button>
                    <button
                        @click="viewMode = 'map'"
                        :class="{'text-blue-500': viewMode === 'map', 'text-gray-500': viewMode !== 'map'}"
                        aria-label="Switch to map view"
                        title="Map view"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                            />
                        </svg>
                    </button>
                </div>
            </div>
            <div>
                <template x-if="viewMode === 'map' && currentCategory === 'World'">
                    <div class="py-4">
                        <iframe
                            :src="'kite_map.html?timestamp=' + Date.now()"
                            class="w-full h-[calc(100vh-200px)] border-none"
                        ></iframe>
                    </div>
                </template>
                <template x-if="viewMode === 'list' && currentCategory === 'OnThisDay'">
                    <div
                        class="py-4"
                        x-data="{ hoveredLink: null, popupContent: null, popupVisible: false, popupPosition: { x: 0, y: 0 } }"
                    >
                        <h2
                            class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200"
                            x-text="new Date().toLocaleString('en-US', { month: 'long', day: 'numeric' })"
                        ></h2>
                        <div class="relative">
                            <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-blue-200 dark:bg-blue-700"></div>
                            <ul class="list-none space-y-6 mb-4 relative">
                                <template x-for="(event, index) in stories" :key="index">
                                    <li class="ml-6">
                                        <div class="absolute -left-3 mt-1.5">
                                            <div
                                                class="w-8 h-8 rounded-full bg-blue-500 border-4 border-white dark:border-gray-800 flex items-center justify-center"
                                            >
                                                <span
                                                    class="text-white text-xs font-bold"
                                                    x-text="index + 1"
                                                ></span>
                                            </div>
                                        </div>
                                        <div class="p-2 bg-white dark:bg-gray-700 rounded-lg">
                                            <p
                                                class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-1"
                                                x-text="event.year"
                                            ></p>
                                            <p
                                                class="text-gray-700 dark:text-gray-300"
                                                x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                                                @mouseover.capture="(e) => handleLinkHover(e, $el)"
                                                @mouseleave="hoveredLink = null; popupVisible = false;"
                                            ></p>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <!-- Wikipedia Popup -->
                        <div
                            x-show="popupVisible"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="fixed z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 max-w-md"
                            :style="`left: ${popupPosition.x}px; top: ${popupPosition.y}px;`"
                        >
                            <div class="flex">
                                <div class="flex-1 pr-4">
                                    <p
                                        class="text-sm text-gray-600 dark:text-gray-400 mb-2"
                                        x-text="popupContent?.description"
                                    ></p>
                                    <p class="text-sm" x-html="popupContent?.extract_html"></p>
                                </div>
                                <div class="flex-shrink-0 w-1/3">
                                    <img
                                        x-show="popupContent?.thumbnail"
                                        :src="popupContent?.thumbnail?.source"
                                        :alt="popupContent?.title"
                                        class="w-full h-auto rounded"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <template x-if="currentCategory !== 'OnThisDay'">
                    <template x-for="(story, index) in stories" :key="story.cluster_number">
                        <article
                            :id="'story-' + index"
                            role="article"
                            :aria-expanded="story.expanded"
                            :aria-label="'News story: ' + story.title"
                            class="py-4 relative"
                            :class="{'border-b border-gray-200 dark:border-gray-700': !story.expanded}"
                        >
                            <header class="flex justify-between items-center mb-2">
                                <span
                                    class="category-label text-gray-700 dark:text-gray-300 text-sm py-1 rounded inline-flex items-center"
                                >
                                    <span
                                        :class="'topic-color-' + ((story.category.charCodeAt(0) + story.category.charCodeAt(1) + story.category.length) % 9 + 1)"
                                        x-text="story.category"
                                    ></span>
                                    <svg
                                        class="ml-4 mr-1"
                                        width="13"
                                        height="13"
                                        viewBox="0 0 13 13"
                                        fill="none"
                                        xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            clip-rule="evenodd"
                                            d="M5.71989 3.1291C5.56044 3.04938 5.37276 3.04938 5.2133 3.1291L2.60163 4.43494L5.21331 5.74078C5.37276 5.82051 5.56044 5.82051 5.71989 5.74078L8.33157 4.43494L5.71989 3.1291ZM4.90935 2.5212C5.26015 2.3458 5.67305 2.3458 6.02385 2.5212L9.0408 4.02967C9.37476 4.19665 9.37476 4.67323 9.0408 4.84021L6.02385 6.34869C5.67305 6.52409 5.26015 6.52409 4.90935 6.34869L1.8924 4.84021C1.55844 4.67323 1.55844 4.19665 1.8924 4.02967L4.90935 2.5212ZM1.53779 6.09539C1.62172 5.92753 1.82585 5.85948 1.99372 5.94342L5.21331 7.55321C5.37276 7.63294 5.56044 7.63294 5.71989 7.55321L8.93948 5.94342C9.10735 5.85948 9.31147 5.92753 9.39541 6.09539C9.47934 6.26326 9.4113 6.46739 9.24343 6.55132L6.02385 8.16112C5.67305 8.33651 5.26015 8.33651 4.90935 8.16112L1.68977 6.55132C1.5219 6.46739 1.45386 6.26326 1.53779 6.09539ZM1.53779 7.90782C1.62172 7.73995 1.82585 7.67191 1.99372 7.75585L5.21331 9.36564C5.37276 9.44536 5.56044 9.44536 5.71989 9.36564L8.93948 7.75585C9.10735 7.67191 9.31147 7.73995 9.39541 7.90782C9.47934 8.07569 9.4113 8.27982 9.24343 8.36375L6.02385 9.97354C5.67305 10.1489 5.26015 10.1489 4.90935 9.97354L1.68977 8.36375C1.5219 8.27982 1.45386 8.07569 1.53779 7.90782Z"
                                            fill="currentColor"
                                        />
                                    </svg>
                                    <span x-text="story.domains.length + ' Sources'"></span>
                                </span>
                            </header>
                            <div class="flex items-start">
                                <div class="flex-grow">
                                    <h2
                                        class="text-xl text-gray-800 dark:text-dark-text mb-2 cursor-pointer"
                                        :class="readStories[story.title] ? '' : 'font-semibold'"
                                        x-text="story.title"
                                        @click="toggleStory(story, index)"
                                        :id="'story-title-' + index"
                                    ></h2>
                                </div>
                                <div class="flex-shrink-0 ml-4 -mt-3">
                                    <button
                                        @click.stop="readStories[story.title] = !readStories[story.title]; localStorage.setItem('readStories', JSON.stringify(readStories))"
                                        class="focus:outline-none"
                                    >
                                        <svg
                                            :class="readStories[story.title] ? 'text-gray-600 dark:text-gray-400' : 'text-gray-300 dark:text-gray-600'"
                                            class="w-6 h-6"
                                            xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20"
                                            :fill="readStories[story.title] ? '#7BA3FF' : 'currentColor'"
                                            :stroke="readStories[story.title] ? '#427AFC' : 'none'"
                                            title="Click to toggle read status"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                clip-rule="evenodd"
                                            />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <section x-show="story.expanded" class="py-4 bg-white dark:bg-dark-bg" @click.stop>
                                <!-- Summary -->
                                <p
                                    x-show="$store.components.list.find(c => c.id === 'summary')?.enabled"
                                    class="mb-6"
                                    x-text="story.short_summary"
                                ></p>

                                <!-- Location -->
                                <p
                                    x-show="story.location && $store.components.list.find(c => c.id === 'location')?.enabled"
                                    class="flex items-center text-gray-600 dark:text-gray-300 mb-6"
                                >
                                    <img src="{{ static_path }}/svg/map.svg" alt="Map icon" class="w-5 h-5 mr-2" />
                                    <span x-text="story.location"></span>
                                </p>

                                <!-- Main Image -->
                                <figure
                                    x-show="story.articles.some(a => a.image) && $store.components.list.find(c => c.id === 'main_image')?.enabled"
                                    class="mb-6"
                                >
                                    <div class="relative">
                                        <template x-if="story.articles.find(a => a.image)">
                                            <div class="relative w-full max-w-[800px] mx-auto">
                                                <a
                                                    :href="story.articles.find(a => a.image).link"
                                                    target="_blank"
                                                    class="relative block"
                                                >
                                                    <img
                                                        :src="story.articles.find(a => a.image).image"
                                                        :alt="story.articles.find(a => a.image).image_caption || 'Story image'"
                                                        class="w-full h-auto rounded-lg shadow-md"
                                                        loading="lazy"
                                                    />
                                                    <div
                                                        class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded hover:bg-opacity-75"
                                                    >
                                                        <span
                                                            x-text="story.articles.find(a => a.image).domain"
                                                        ></span>
                                                    </div>
                                                </a>
                                                <template x-if="story.articles.find(a => a.image).image_caption">
                                                    <p
                                                        class="mt-2 text-sm text-gray-600 dark:text-gray-400 italic"
                                                        x-text="story.articles.find(a => a.image).image_caption"
                                                    ></p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </figure>

                                <!-- Highlights -->
                                <section x-show="$store.components.list.find(c => c.id === 'highlights')?.enabled">
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">
                                        Highlights
                                    </h3>
                                    <div class="border-t border-dashed border-gray-300 dark:border-gray-600">
                                        <template x-for="(point, index) in story.talking_points" :key="point">
                                            <div
                                                class="py-4 border-b border-dashed border-gray-300 dark:border-gray-600 relative pl-10"
                                            >
                                                <div class="absolute left-0 top-4">
                                                    <div
                                                        class="w-6 h-6 rounded-full bg-[#F9D9B8] flex items-center justify-center"
                                                    >
                                                        <span
                                                            class="text-gray-800 text-sm font-semibold"
                                                            x-text="index + 1"
                                                        ></span>
                                                    </div>
                                                </div>
                                                <template x-if="point.includes(':')">
                                                    <div>
                                                        <div class="flex items-start">
                                                            <h4
                                                                class="font-semibold text-gray-800 dark:text-gray-200 mb-2"
                                                                x-text="point.split(':')[0].trim()"
                                                            ></h4>
                                                        </div>
                                                        <p
                                                            class="text-gray-700 dark:text-gray-300 -ml-10"
                                                            x-text="point.split(':')[1].trim()"
                                                        ></p>
                                                    </div>
                                                </template>
                                                <template x-if="!point.includes(':')">
                                                    <p class="text-gray-700 dark:text-gray-300" x-text="point"></p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </section>

                                <!-- Quote -->
                                <section
                                    x-show="story.quote && $store.components.list.find(c => c.id === 'quote')?.enabled"
                                    class="my-8 bg-[#F3F6FE] dark:bg-gray-700 rounded-lg p-4"
                                >
                                    <blockquote class="text-lg text-black dark:text-white">
                                        <span x-text="story.quote"></span>
                                    </blockquote>
                                    <p
                                        x-show="story.quote_author"
                                        class="text-left text-gray-700 dark:text-gray-300 mt-2"
                                    >
                                        <template x-if="story.quote_source_url">
                                            <a
                                                :href="story.quote_source_url"
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-[#183FDC] dark:text-[#5B89FF] hover:underline"
                                            >
                                                <span
                                                    x-text="story.quote_author + (story.quote_source_domain ? ' (via ' + story.quote_source_domain + ')' : '')"
                                                ></span>
                                            </a>
                                        </template>
                                        <template x-if="!story.quote_source_url">
                                            <span x-text="story.quote_author"></span>
                                        </template>
                                    </p>
                                </section>

                                <!-- Additional Images -->
                                <section
                                    x-show="story.articles.filter(a => a.image).length >= 2 && $store.components.list.find(c => c.id === 'additional_image')?.enabled"
                                    class="mt-6"
                                >
                                    <template x-if="story.articles.filter(a => a.image)[1]">
                                        <div class="relative w-full max-w-[800px] mx-auto">
                                            <a
                                                :href="story.articles.filter(a => a.image)[1].link"
                                                target="_blank"
                                                class="relative block"
                                            >
                                                <img
                                                    :src="story.expanded ? story.articles.filter(a => a.image)[1].image : ''"
                                                    :alt="story.articles.filter(a => a.image)[1].image_caption || 'Additional story image'"
                                                    loading="lazy"
                                                    class="w-full h-auto rounded-lg shadow-md"
                                                />
                                                <div
                                                    class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded hover:bg-opacity-75"
                                                >
                                                    <span
                                                        x-text="story.articles.filter(a => a.image)[1].domain"
                                                    ></span>
                                                </div>
                                            </a>
                                            <template x-if="story.articles.filter(a => a.image)[1].image_caption">
                                                <p
                                                    class="mt-2 text-sm text-gray-600 dark:text-gray-400 italic"
                                                    x-text="story.articles.filter(a => a.image)[1].image_caption"
                                                ></p>
                                            </template>
                                        </div>
                                    </template>
                                </section>

                                <!-- Perspectives -->
                                <section
                                    x-show="story.perspectives && story.perspectives.length > 0 && $store.components.list.find(c => c.id === 'perspectives')?.enabled"
                                    class="mt-6"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">
                                        Perspectives
                                    </h3>
                                    <div class="flex flex-row overflow-x-auto gap-3 pb-4">
                                        <template x-for="(perspective, index) in story.perspectives" :key="index">
                                            <div
                                                class="flex-shrink-0 w-56 bg-gray-100 dark:bg-gray-700 rounded-lg p-4"
                                            >
                                                <p
                                                    class="text-gray-800 dark:text-gray-200 font-bold mb-2"
                                                    x-text="perspective.text.includes(':') ? perspective.text.split(':')[0] : ''"
                                                ></p>
                                                <p
                                                    class="text-gray-700 dark:text-gray-300 mb-2"
                                                    x-text="perspective.text.includes(':') ? perspective.text.split(':').slice(1).join(':').trim() : perspective.text"
                                                ></p>
                                                <template
                                                    x-if="perspective.sources && perspective.sources.length > 0"
                                                >
                                                    <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                                        <template
                                                            x-for="(source, index) in perspective.sources"
                                                            :key="index"
                                                        >
                                                            <span>
                                                                <a
                                                                    :href="source.url"
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    class="text-[#183FDC] dark:text-[#5B89FF] hover:underline"
                                                                    x-text="source.name"
                                                                ></a>
                                                                <template
                                                                    x-if="index < perspective.sources.length - 1"
                                                                >
                                                                    <span>•</span>
                                                                </template>
                                                            </span>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </section>

                                <!-- Geopolitical Context -->
                                <section
                                    x-show="story.geopolitical_context && $store.components.list.find(c => c.id === 'geopolitical_context')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Geopolitical context
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.geopolitical_context"
                                    ></p>
                                </section>

                                <!-- Historical Background -->
                                <section
                                    x-show="story.historical_background && $store.components.list.find(c => c.id === 'historical_background')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Historical background
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.historical_background"
                                    ></p>
                                </section>

                                <!-- Humanitarian Impact -->
                                <section
                                    x-show="story.humanitarian_impact && $store.components.list.find(c => c.id === 'humanitarian_impact')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Humanitarian impact
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.humanitarian_impact"
                                    ></p>
                                </section>

                                <!-- Technical Details -->
                                <section
                                    x-show="story.technical_details && story.technical_details.length > 0 && $store.components.list.find(c => c.id === 'technical_details')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Technical details
                                    </h3>
                                    <ul
                                        class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2"
                                    >
                                        <template x-for="detail in story.technical_details" :key="detail">
                                            <li x-text="detail"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Business Angle -->
                                <section
                                    x-show="(story.business_angle_text || (story.business_angle_points && story.business_angle_points.length > 0)) && $store.components.list.find(c => c.id === 'business_angle')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Business angle
                                    </h3>
                                    <p
                                        x-show="story.business_angle_text"
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.business_angle_text"
                                    ></p>
                                    <ul
                                        x-show="story.business_angle_points && story.business_angle_points.length > 0"
                                        class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2"
                                    >
                                        <template x-for="point in story.business_angle_points" :key="point">
                                            <li x-text="point"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- International Reactions -->
                                <section
                                    x-show="story.international_reactions && story.international_reactions.length > 0 && $store.components.list.find(c => c.id === 'international_reactions')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        International reactions
                                    </h3>
                                    <div class="space-y-2">
                                        <template x-for="reaction in story.international_reactions" :key="reaction">
                                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                                <template
                                                    x-if="typeof reaction === 'string' && reaction.includes(':')"
                                                >
                                                    <div>
                                                        <h4
                                                            class="font-semibold text-gray-800 dark:text-gray-200"
                                                            x-text="reaction.split(':')[0].trim()"
                                                        ></h4>
                                                        <p
                                                            class="text-gray-700 dark:text-gray-300"
                                                            x-text="reaction.split(':')[1].trim().endsWith('.') ? reaction.split(':')[1].trim() : reaction.split(':')[1].trim() + '.'"
                                                        ></p>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="typeof reaction === 'string' && !reaction.includes(':')"
                                                >
                                                    <p
                                                        class="text-gray-700 dark:text-gray-300"
                                                        x-text="reaction.endsWith('.') ? reaction : reaction + '.'"
                                                    ></p>
                                                </template>
                                                <template x-if="typeof reaction !== 'string'">
                                                    <p class="text-gray-700 dark:text-gray-300">
                                                        Invalid reaction format
                                                    </p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </section>

                                <!-- Scientific Significance -->
                                <section
                                    x-show="story.scientific_significance && story.scientific_significance.length > 0 && $store.components.list.find(c => c.id === 'scientific_significance')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Scientific significance
                                    </h3>
                                    <ul
                                        class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2"
                                    >
                                        <template x-for="point in story.scientific_significance" :key="point">
                                            <li x-text="point"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Travel Advisory -->
                                <section
                                    x-show="story.travel_advisory && story.travel_advisory.length > 0 && $store.components.list.find(c => c.id === 'travel_advisory')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Travel advisory
                                    </h3>
                                    <ul
                                        class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2"
                                    >
                                        <template x-for="point in story.travel_advisory" :key="point">
                                            <li x-text="point"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Performance Statistics -->
                                <section
                                    x-show="story.performance_statistics && story.performance_statistics.length > 0 && $store.components.list.find(c => c.id === 'performance_statistics')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Performance statistics
                                    </h3>
                                    <ul
                                        class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2"
                                    >
                                        <template x-for="stat in story.performance_statistics" :key="stat">
                                            <li x-text="stat"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- League Standings -->
                                <section
                                    x-show="story.league_standings && $store.components.list.find(c => c.id === 'league_standings')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        League standings
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.league_standings"
                                    ></p>
                                </section>

                                <!-- Design Principles -->
                                <section
                                    x-show="story.design_principles && $store.components.list.find(c => c.id === 'design_principles')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Design principles
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.design_principles"
                                    ></p>
                                </section>

                                <!-- User Experience Impact -->
                                <section
                                    x-show="story.user_experience_impact && story.user_experience_impact.length > 0 && $store.components.list.find(c => c.id === 'user_experience_impact')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        User experience impact
                                    </h3>
                                    <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                        <template x-for="impact in story.user_experience_impact" :key="impact">
                                            <li x-text="impact"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Gameplay Mechanics -->
                                <section
                                    x-show="story.gameplay_mechanics && story.gameplay_mechanics.length > 0 && $store.components.list.find(c => c.id === 'gameplay_mechanics')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Gameplay mechanics
                                    </h3>
                                    <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                        <template x-for="mechanic in story.gameplay_mechanics" :key="mechanic">
                                            <li x-text="mechanic"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Gaming Industry Impact -->
                                <section
                                    x-show="story.gaming_industry_impact && story.gaming_industry_impact.length > 0 && $store.components.list.find(c => c.id === 'gaming_industry_impact')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Industry impact
                                    </h3>
                                    <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                        <template x-for="impact in story.gaming_industry_impact" :key="impact">
                                            <li x-text="impact"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Technical Specifications -->
                                <section
                                    x-show="story.technical_specifications && $store.components.list.find(c => c.id === 'technical_specifications')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Technical specifications
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.technical_specifications"
                                    ></p>
                                </section>

                                <!-- Timeline -->
                                <section
                                    x-show="story.timeline && story.timeline.length > 0 && $store.components.list.find(c => c.id === 'timeline')?.enabled"
                                >
                                    <h2 class="timeline-title text-xl mt-6 mb-4">Timeline of events</h2>
                                    <div class="timeline">
                                        <template x-for="(event, index) in story.timeline" :key="index">
                                            <div class="row">
                                                <div class="head">
                                                    <span class="step"></span>
                                                    <span
                                                        class="item-title"
                                                        x-text="typeof event === 'object' ? event.date : 
                                                (typeof event === 'string' && event.includes('::')) ? event.split('::')[0] : ''"
                                                    ></span>
                                                </div>
                                                <div class="body">
                                                    <span
                                                        x-text="typeof event === 'object' ? event.description :
                                                (typeof event === 'string' && event.includes('::')) ? event.split('::')[1] : event"
                                                    ></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </section>

                                <!-- Future Outlook -->
                                <section
                                    x-show="story.future_outlook && $store.components.list.find(c => c.id === 'future_outlook')?.enabled"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                        Future outlook
                                    </h3>
                                    <p
                                        class="mb-4 text-gray-700 dark:text-gray-300"
                                        x-text="story.future_outlook"
                                    ></p>
                                </section>

                                <!-- Sources -->
                                <section
                                    x-show="$store.components.list.find(c => c.id === 'sources')?.enabled"
                                    x-data="{ showAllSources: false, visibleSources: 8 }"
                                >
                                    <div class="flex items-center justify-between mt-6 mb-4">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
                                            Sources
                                        </h3>
                                        <button
                                            x-show="story.domains && story.domains.length > visibleSources"
                                            @click="showAllSources = !showAllSources"
                                            class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 focus:outline-none"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 inline-block ml-1 transform transition-transform duration-200"
                                                :class="{'rotate-180': showAllSources}"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 9l-7 7-7-7"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        <template x-if="story.domains">
                                            <template x-for="(domain, index) in story.domains" :key="index">
                                                <button
                                                    x-show="index < visibleSources || showAllSources"
                                                    class="flex flex-col items-start space-y-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-lg transition-colors"
                                                    @click.stop="$dispatch('open-source', { domain: domain, story: story })"
                                                    :aria-label="'Show articles from ' + (domain?.name || 'Unknown')"
                                                    :title="'Show articles from ' + (domain?.name || 'Unknown')"
                                                >
                                                    <div class="flex items-center space-x-2">
                                                        <img
                                                            :src="domain?.favicon || '{{ static_path }}/svg/placeholder.svg'"
                                                            :alt="domain?.name ? domain.name + ' Favicon' : 'Default Favicon'"
                                                            class="w-5 h-5 rounded-full"
                                                            loading="lazy"
                                                        />
                                                        <span
                                                            class="text-sm font-semibold"
                                                            x-text="domain?.name || 'Unknown'"
                                                        ></span>
                                                    </div>
                                                    <span
                                                        class="text-xs text-gray-500 dark:text-gray-400 ml-7"
                                                        x-text="story?.articles ? (story.articles.filter(a => a.domain === domain?.name).length + ' articles') : '0 articles'"
                                                    ></span>
                                                </button>
                                            </template>
                                        </template>
                                    </div>
                                </section>

                                <!-- Action Items -->
                                <section
                                    x-show="story.user_action_items && story.user_action_items.length > 0 && $store.components.list.find(c => c.id === 'action_items')?.enabled"
                                    class="bg-[#F1FAE8] dark:bg-[#2B411C] rounded-lg p-4 mt-6"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">
                                        Action items
                                    </h3>
                                    <ul class="list-disc ml-4 mb-2 text-gray-700 dark:text-gray-200 space-y-2">
                                        <template x-for="item in story.user_action_items" :key="item">
                                            <li x-text="item"></li>
                                        </template>
                                    </ul>
                                </section>

                                <!-- Did You Know -->
                                <section
                                    x-show="story.did_you_know && $store.components.list.find(c => c.id === 'did_you_know')?.enabled"
                                    class="bg-[#CED8FB] dark:bg-[#2A3B5E] rounded-lg p-4 mt-6"
                                >
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">
                                        Did you know?
                                    </h3>
                                    <p class="text-gray-700 dark:text-gray-200" x-text="story.did_you_know"></p>
                                </section>

                                <div class="flex justify-center items-center space-x-4 mt-6 w-full md:px-0">
                                    <button
                                        @click.stop="shareArticle(story)"
                                        :data-share-url="window.location.origin + window.location.pathname + '?article=' + currentCategory.toLowerCase() + '-' + story.cluster_number"
                                        class="w-full md:w-auto px-6 py-3 bg-white text-black border border-black font-semibold rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                                    >
                                        Share this
                                    </button>
                                    <button
                                        @click.stop="closeStory(story, index)"
                                        class="w-full md:w-auto px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                                    >
                                        Close story
                                    </button>
                                </div>
                            </section>
                            <!-- Sources section -->
                        </article>
                        <!-- story article -->
                    </template>
                    <!-- x-for stories template -->
                </template>
                <!-- x-if currentCategory template -->
            </div>
            <!-- outer div -->
        </div>
        <!-- container -->
    </main>

    <div
        x-show="showSourceOverlay"
        x-cloak
        @open-source.window="processSource($event)"
        @click.self="showSourceOverlay = false"
        class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4"
    >
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <header class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <img
                        :src="currentSource?.favicon || '{{ static_path }}/svg/placeholder.svg'"
                        :alt="currentSource?.name ? `${currentSource.name} favicon` : 'Generic favicon'"
                        class="w-6 h-6"
                    />
                    <h3
                        class="text-xl font-bold dark:text-dark-text"
                        x-text="currentSource?.name || 'Unknown Source'"
                    ></h3>
                </div>
                <button
                    @click="showSourceOverlay = false"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        />
                    </svg>
                </button>
            </header>
            <p
                class="text-gray-600 dark:text-gray-400 mb-4"
                x-text="(sourceArticles || []).length + ' articles'"
            ></p>
            <div class="space-y-4">
                <template x-for="article in sourceArticles" :key="article.link">
                    <article class="flex space-x-4">
                        <img
                            x-bind:src="article.image || '{{ static_path }}/svg/placeholder.svg'"
                            alt="Article image"
                            class="w-24 h-24 object-cover rounded"
                        />
                        <div>
                            <a
                                :href="article.link"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="hover:underline"
                                @click.stop
                            >
                                <h4 class="font-semibold dark:text-dark-text" x-text="article.title"></h4>
                            </a>
                            <p
                                class="text-sm text-gray-500 dark:text-gray-400"
                                x-text="new Date(article.date).toLocaleString()"
                            ></p>
                        </div>
                    </article>
                </template>
            </div>

            <!-- Source Information -->
            <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-4">
                <button
                    @click="showSourceInfo = !showSourceInfo"
                    class="w-full flex justify-between items-center text-left text-gray-800 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg"
                >
                    <span class="font-semibold">Source information</span>
                    <svg
                        class="w-5 h-5 transform transition-transform"
                        :class="{'rotate-180': showSourceInfo}"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd"
                        />
                    </svg>
                </button>

                <div
                    x-show="showSourceInfo"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform -translate-y-2"
                    x-transition:enter-end="opacity-100 transform translate-y-0"
                    class="mt-4"
                >
                    <!-- Show this when media info exists -->
                    <template x-if="mediaInfo">
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <!-- Country -->
                                <div class="flex items-center gap-2">
                                    <svg
                                        class="w-5 h-5 text-gray-500"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"
                                        />
                                    </svg>
                                    <div>
                                        <div class="font-medium text-gray-700 dark:text-gray-300">Country</div>
                                        <div
                                            class="text-gray-600 dark:text-gray-400"
                                            x-text="mediaInfo.country"
                                        ></div>
                                    </div>
                                </div>

                                <!-- Owner -->
                                <div class="flex items-center gap-2">
                                    <svg
                                        class="w-5 h-5 text-gray-500"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                                        />
                                    </svg>
                                    <div>
                                        <div class="font-medium text-gray-700 dark:text-gray-300">Owner</div>
                                        <div
                                            class="text-gray-600 dark:text-gray-400"
                                            x-text="mediaInfo.owner || 'Not specified'"
                                        ></div>
                                    </div>
                                </div>

                                <!-- Organization -->
                                <div class="flex items-center gap-2">
                                    <svg
                                        class="w-5 h-5 text-gray-500"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                                        />
                                    </svg>
                                    <div>
                                        <div class="font-medium text-gray-700 dark:text-gray-300">Organization</div>
                                        <div
                                            class="text-gray-600 dark:text-gray-400"
                                            x-text="mediaInfo.organization"
                                        ></div>
                                    </div>
                                </div>

                                <!-- Media Classification -->
                                <div class="flex items-center gap-2">
                                    <svg
                                        class="w-5 h-5 text-gray-500"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        />
                                    </svg>
                                    <div>
                                        <div class="font-medium text-gray-700 dark:text-gray-300">
                                            Media Classification
                                        </div>
                                        <div
                                            class="text-gray-600 dark:text-gray-400"
                                            x-text="mediaInfo.typology"
                                        ></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="space-y-4">
                                <!-- Description -->
                                <div x-show="mediaInfo.description" class="text-gray-700 dark:text-gray-300">
                                    <h4 class="font-medium mb-2">Description</h4>
                                    <p x-text="mediaInfo.description"></p>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Show this when no media info exists -->
                    <template x-if="!mediaInfo">
                        <div class="text-center py-6">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                                Help improve our database
                            </h4>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                We don't have detailed information about this news source yet. Your contribution can
                                help others stay informed about media ownership and bias.
                            </p>
                            <a
                                href="https://github.com/kagisearch/kite-public"
                                class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200"
                            >
                                <svg
                                    class="w-5 h-5 mr-2"
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                                    />
                                </svg>
                                Contribute Information
                            </a>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div
        x-data
        x-show="$store.settings.isOpen"
        x-cloak
        role="complementary"
        aria-label="Settings panel"
        class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50"
        @click.self="$store.settings.close()"
        @keydown.escape.window="$store.settings.close()"
    >
        <div
            class="bg-white dark:bg-gray-800 w-full h-full md:rounded-lg md:p-8 md:max-w-md md:h-auto md:max-h-[90vh] shadow-xl overflow-y-auto flex flex-col"
            @click.stop
        >
            <header class="flex-shrink-0 bg-white dark:bg-gray-800 p-4 md:p-0 md:mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Settings</h2>
                    <button
                        @click="$store.settings.close()"
                        class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            />
                        </svg>
                    </button>
                </div>
                <button
                    @click="$store.settings.close(); showIntro = true"
                    class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 text-sm font-medium flex items-center justify-center space-x-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                    </svg>
                    <span>About Kite</span>
                </button>
            </header>
            <div class="p-4 md:p-0">
                <div class="space-y-6">
                    <div class="flex flex-col space-y-2">
                        <label for="theme-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Theme
                        </label>
                        <div class="relative">
                            <select
                                id="theme-select"
                                x-model="$store.theme.current"
                                @change="$store.theme.set($event.target.value)"
                                aria-label="Select theme preference"
                                class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                            >
                                <option value="system">System</option>
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                            >
                                <svg
                                    class="fill-current h-4 w-4"
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                                    />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="font-size-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Font size
                        </label>
                        <div class="relative">
                            <select
                                id="font-size-select"
                                x-model="$store.fontSize.current"
                                @change="$store.fontSize.set($event.target.value)"
                                aria-label="Select text size"
                                class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                            >
                                <option value="small">Small</option>
                                <option value="normal">Normal</option>
                                <option value="large">Large</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                            >
                                <svg
                                    class="fill-current h-4 w-4"
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                                    />
                                    k
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="story-count-range" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Number of stories shown:
                            <span x-text="$store.storyCount.current"></span>
                        </label>
                        <input
                            id="story-count-range"
                            type="range"
                            min="3"
                            max="12"
                            x-model="$store.storyCount.current"
                            @input="$store.storyCount.set($event.target.value); changeCategory()"
                            @mousedown="lockScroll"
                            @mouseup="unlockScroll"
                            @touchstart="lockScroll"
                            @touchend="unlockScroll"
                            aria-label="Adjust number of stories shown"
                            aria-valuemin="3"
                            aria-valuemax="12"
                            :aria-valuenow="$store.storyCount.current"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                        />
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Story Components</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Toggle components on/off. Not all components are available for all articles.
                        </p>

                        <div id="story-components" class="space-y-3">
                            <!-- Core Content Components -->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">Core Content</span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['summary', 'location', 'main_image', 'highlights'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!-- Media Components -->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">Media</span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['additional_image', 'quote'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!-- Context Components Group -->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">
                                        Context & Background
                                    </span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['perspectives', 'geopolitical_context', 'historical_background', 'humanitarian_impact', 'international_reactions'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Technical Components Group -->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">
                                        Technical & Business
                                    </span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['technical_details', 'business_angle', 'technical_specifications', 'user_experience_impact'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Business & Performance Group-->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">
                                        Business & Performance
                                    </span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['business_angle', 'gaming_industry_impact', 'performance_statistics', 'league_standings'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!-- Additional Components Group -->
                            <div
                                x-data="{ open: false }"
                                class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden"
                            >
                                <button
                                    @click="open = !open"
                                    class="w-full p-3 flex justify-between items-center bg-gray-50 dark:bg-gray-800"
                                >
                                    <span class="font-medium text-gray-700 dark:text-gray-300">
                                        Additional Information
                                    </span>
                                    <svg
                                        class="w-5 h-5 transform transition-transform"
                                        :class="open ? 'rotate-180' : ''"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div x-show="open" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <template
                                        x-for="component in $store.components.list.filter(c => ['timeline', 'sources', 'future_outlook', 'scientific_significance', 'travel_advisory', 'did_you_know', 'action_items'].includes(c.id))"
                                        :key="component.id"
                                    >
                                        <div
                                            class="flex items-center justify-between p-3 bg-white dark:bg-gray-700"
                                        >
                                            <span
                                                class="text-gray-700 dark:text-gray-300"
                                                x-text="component.name"
                                            ></span>
                                            <button
                                                @click="$store.components.toggle(component.id)"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                                :class="component.enabled ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'"
                                                role="switch"
                                                :aria-checked="component.enabled"
                                            >
                                                <span
                                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                                    :class="component.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                ></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Categories</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Tap to toggle. Drag enabled categories to reorder.
                        </p>

                        <!-- Enabled categories grid -->
                        <div id="enabled-categories" class="grid grid-cols-3 gap-3 mb-4" x-ref="enabledCategories">
                            <template
                                x-for="category in availableCategories.filter(c => $store.categories.isEnabled(c.name))"
                                :key="category.name"
                            >
                                <div
                                    :data-category="category.name"
                                    class="bg-blue-500 text-white px-4 py-3 rounded-md text-sm font-medium cursor-pointer flex items-center justify-center min-h-[48px]"
                                    @click="handleCategoryClick(category)"
                                >
                                    <span x-text="category.name"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Separator -->
                        <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                        <!-- Disabled categories grid -->
                        <div class="grid grid-cols-3 gap-3">
                            <template
                                x-for="category in availableCategories.filter(c => !$store.categories.isEnabled(c.name))"
                                :key="category.name"
                            >
                                <div
                                    :data-category="category.name"
                                    class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-md text-sm font-medium cursor-pointer min-h-[48px] flex items-center justify-center"
                                    @click="$store.categories.toggle(category.name); updateCategoryDropdown(); changeCategory();"
                                    x-text="category.name"
                                ></div>
                            </template>
                        </div>
                        <!-- Contribute link -->
                        <div class="flex justify-center mt-4">
                            <a
                                href="https://github.com/kagisearch/kite-public"
                                class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-sm"
                            >
                                + Community curated categories
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-4 mt-8">
        <div class="container mx-auto px-4 max-w-[732px] flex justify-center items-center">
            <a
                :href="currentCategory === 'OnThisDay' ? 'https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday' : currentCategory.toLowerCase() + '.xml'"
                target="_blank"
                class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 flex items-center space-x-2"
                title="RSS feed"
            >
                <img src="{{ static_path }}/svg/rss.svg" alt="" class="h-5 w-5 dark:invert" aria-hidden="true" />
                <span class="text-sm">RSS Feed</span>
            </a>
        </div>
    </footer>
</body>
</html>
